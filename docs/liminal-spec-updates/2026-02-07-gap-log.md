# Liminal Spec Gap Log (2026-02-07)

## Purpose

Track gaps found in this project's Feature Spec and Tech Design, then decide whether each gap should be addressed by improving the `liminal-spec` skill itself.

## Snapshot

This review compared:
- `docs/tech-design-mvp.md`
- `~/promptdb/docs/tech-arch/*.md`
- current local stack and package strategy

The key pattern: core protocol and flow design quality is strong, but cross-cutting architecture controls were under-specified until late (dependency baseline, NFR targets, threat model, env contract, and error contract).

## Gaps Found In Current Spec/Design

| ID | Gap | Impact | Added to Project Docs | Candidate Skill Improvement? |
|----|-----|--------|-----------------------|------------------------------|
| G-01 | No explicit dependency baseline strategy (runtime vs dev, version policy, optional packages) | Late churn in package choices and scripts | Yes | Yes |
| G-02 | Testing runner/tooling strategy decided late (Bun test vs Vitest projects) | Test organization and CI shape unclear | Yes | Yes |
| G-03 | Missing non-functional targets (latency, recovery, startup expectations) | Hard to evaluate readiness and regressions | Yes | Yes |
| G-04 | Missing constraints-accepted section | Hidden trade-offs stay implicit | Yes | Yes |
| G-05 | Missing threat model + input validation matrix | Security and robustness checks are ad hoc | Yes | Yes |
| G-06 | Missing runtime/env prerequisites matrix | Setup friction and hidden assumptions | Yes | Yes |
| G-07 | Missing machine-readable error contract (codes) | Inconsistent client error handling | Yes | Yes |
| G-08 | No explicit architecture pattern gate before execution | Important questions asked too late | Yes | Yes |
| G-09 | No explicit verification tiers (`verify` vs `verify-all`) in design-time planning | Inconsistent quality gates across stories and handoffs | Yes | Yes |
| G-10 | No policy for breaking up large tech design docs | Design readability and maintainability degrade as scope grows | Yes | Yes |
| G-11 | Parallel-agent guidance can over-emphasize coordination instead of hard task boundaries | Higher communication overhead, scope creep, and merge friction | Yes | Yes |

## What PromptDB Did Well That We Should Reuse

1. Trade-off tables with explicit "Constraints Accepted".
2. Requirements section including measurable NFR targets.
3. Threat model and input-validation coverage tied to tests.
4. Environment variable and runtime contract as first-class design artifact.
5. Error response catalog with stable codes/messages.
6. Tooling consistency (Biome single tool for lint+format, Vitest projects for test segmentation).

## Proposed `liminal-spec` Skill Refinements

### Phase 2 (Feature Specification) additions

1. Add a required "Architecture Context Capture" mini-section:
   - Existing stack and runtime constraints
   - Required compatibility targets
   - Hard dependency preferences (if any)
2. Promote NFRs from optional to default-required for system features.
3. Add a mandatory "Assumptions to Validate Before Story 0" table.

### Phase 3 (Tech Design) additions

1. Add a required "Dependency and Tooling Baseline" section:
   - Runtime dependencies
   - Dev dependencies
   - Version policy (pinning strategy)
   - Script contract
   - Verification tiers (`verify`, `verify-all`) with exact command composition
2. Add required cross-cutting sections:
   - Constraints Accepted
   - Threat Model + Input Validation Matrix
   - Runtime Prerequisites + Environment Contract
   - Error Contract (machine-readable codes)
   - Non-functional target table
3. Add a "Phase 3 Gate: Architecture Pattern Checklist" before handoff to story sharding.
4. Add required "Design Document Decomposition Plan":
   - break-out thresholds
   - split strategy (by domain/altitude)
   - source-of-truth index doc

## Verification Protocol (Required in Tech Design)

Every Tech Design must define two verification tiers before Story 0 execution:

1. `verify` (regular verification): fast feedback gate used continuously during implementation.
2. `verify-all` (deep verification): broader gate for integration depth and release confidence.

### Required shape

- `verify` must include at least: `format:check`, `lint`, `typecheck`, and primary mocked/service test suites.
- `verify-all` must run `verify` plus integration suites, and include e2e suites when available.
- If integration/e2e suites do not exist yet, `verify-all` must still exist and run placeholders/no-op commands that return success with clear output.

### Example from this project

In `/Users/leemoore/code/liminal-builder/package.json`:

- `verify`: `bun run format:check && bun run lint && bun run typecheck && bun run test`
- `verify-all`: `bun run verify && bun run test:integration && bun run test:e2e`

This should be identified and created during Tech Design, not discovered ad hoc during execution.

## Tech Design Decomposition Policy (Required)

Tech designs naturally become large; decomposition must be intentional.

### Decision triggers for breakout docs

Break out into additional documents when any of these occurs:

1. Primary Tech Design exceeds ~1,500-2,000 lines or navigation overhead becomes material.
2. One domain (auth, protocol, UI architecture, testing, infra) grows dense enough to distract from core flow.
3. A section needs independent review cadence or ownership.

### Breakout method

1. Keep one index/root Tech Design document as the canonical map and decision log.
2. Split into focused companion docs (for example: `tech-design-testing.md`, `tech-design-protocol.md`, `tech-design-ui.md`).
3. Add explicit cross-links and "source of truth" ownership notes per section.
4. Preserve requirement traceability in each breakout doc (AC/TC mappings where relevant).

## Parallel Agent Planning Principle

When recommending parallel agent workflows, prefer hard-bounded work partitions over communication-heavy coordination patterns.

### Guidance

1. Partition work into independent paths with explicit file ownership.
2. Enforce strict no-cross-scope editing during parallel execution.
3. Avoid asking parallel agents to resolve cross-cutting coherence in-flight.
4. Run one explicit post-parallel coherence pass after all bounded tasks complete.

### Why

This reduces quadratic coordination costs, lowers merge/conflict risk, and keeps parallelism focused on truly independent work.

### Phase 4/5 (Story Sharding/Execution) additions

1. Require Story 0 prompt to include explicit setup verification:
   - dependency install success
   - scripts present and runnable
   - format/lint/typecheck/test baseline commands
2. Require validator prompts to check cross-cutting sections, not only module/interface completeness.

## New "Must Ask" Questions For Future Runs

Use these before freezing Phase 2 or Phase 3:

1. What existing stack patterns in adjacent projects should be reused?
2. Which runtime and package ecosystem versions are the compatibility target?
3. Do we need schema-first validation at all external boundaries? If yes, with what library?
4. How should tests be segmented (unit/ui/integration/e2e) and with what runner architecture?
5. What are the measurable NFR targets for startup, latency, reliability, and recovery?
6. What threats are in scope, and where are controls enforced and tested?
7. What env/runtime prerequisites are required locally and in CI?
8. What stable error code contract should clients rely on?
9. What is the `verify` command for regular development verification?
10. What is the `verify-all` command for deep verification, and what does it add beyond `verify`?
11. At what thresholds will Tech Design be split into breakout documents, and what is the split plan?
12. If parallel agents are used, what are the exact hard scope boundaries for each agent?
13. What is the single post-parallel coherence/reconciliation step?

## Tracking Loop

For each newly discovered gap during this build:
1. Record it here with impact and mitigation.
2. Ask: "Can this be solved by improving `liminal-spec` guidance/checklists/templates?"
3. If yes, draft a specific skill update proposal (section + wording + phase).
4. Re-evaluate at story boundaries (after Story 0, after first integration story, before full execution wave).

## Next Candidate Improvements To Draft

1. Update `references/tech-design.md` with a cross-cutting architecture checklist template.
2. Update `references/feature-specification.md` to require architecture-context capture + default NFR table.
3. Add validation prompt snippets for dependency/tooling baseline and threat/input-validation review.
4. Add a standard verification-tier template (`verify` + `verify-all`) to Tech Design guidance and Story 0 prompt guidance.
5. Add a "when/how to split Tech Design docs" section to prevent oversized monolith design docs.
6. Add explicit parallelization guidance: hard boundaries first, one coherence pass after parallel execution.

## Recommended Skill File Changes (for Review)

| File | Recommended Change | Why |
|------|--------------------|-----|
| `/Users/leemoore/.claude/skills/liminal-spec/references/tech-design.md` | Add required "Cross-Cutting Architecture Controls" section with: dependency/tooling baseline, script contract, verification tiers (`verify`/`verify-all`), and doc decomposition policy. Extend handoff checklist to confirm these are defined. | G-01, G-02, G-09, and G-10 happened because architecture/process gates were implied but not explicitly required in Phase 3 guidance. |
| `/Users/leemoore/.claude/skills/liminal-spec/templates/tech-design.template.md` | Add template placeholders/tables for: resolved Tech Design Questions (including verification tiers + decomposition), script contract table, and decomposition thresholds. Add self-review checklist items for these sections. | Template-level nudges are the fastest way to make these controls consistently appear without relying on memory in each run. |
| `/Users/leemoore/.claude/skills/liminal-spec/references/feature-specification.md` | In "Tech Design Questions" guidance/template, include required process questions: `verify`, `verify-all`, and split-plan thresholds. | If these questions are captured in Phase 2, Phase 3 must answer them before execution pressure starts. |
| `/Users/leemoore/.claude/skills/liminal-spec/references/story-sharding.md` | Update Story 0 guidance so setup includes verification scripts and verify prompt expects regular/deep verification gates to be wired, with placeholders allowed when suites do not yet exist. | Story 0 is where project execution contract is created; missing script contract there causes drift and late rework. |
| `/Users/leemoore/.claude/skills/liminal-spec/references/verification.md` | Add pre-story checkpoint items that confirm verification-tier commands are defined and a decomposition decision is documented. | This makes the phase gate enforce the process quality bar, not just module/interface completeness. |
| `/Users/leemoore/.claude/skills/liminal-spec/references/execution-orchestration.md` | Add explicit orchestration rules for parallel execution: hard scope boundaries, no cross-scope edits, and one post-parallel coherence pass. | Parallel execution quality depends more on boundary discipline than in-flight coordination between many agents. |

## Suggested Acceptance Criteria For These Skill Updates

1. A new feature using liminal-spec cannot finish Phase 3 without explicit `verify` and `verify-all` commands.
2. Story 0 prompts require runnable verification commands, even if integration/e2e are placeholders.
3. Tech Design includes an explicit "split/no-split" decision with thresholds and rationale.
4. Verification checkpoints fail if these process artifacts are absent.
5. Parallel agent plans define hard file/task boundaries and a single explicit post-parallel coherence step.
